<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Onboarding - AI Counsellor</title>
  <link rel="stylesheet" href="css/onboarding-chat.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
</head>

<body>

  <div class="split-container">
    <!-- LEFT: CHAT PANEL -->
    <div class="chat-panel">
      <div class="bot-profile">
        <div class="bot-avatar">
          <i class="fas fa-graduation-cap"></i>
        </div>
        <div class="bot-info">
          <h3>ScholarshipAI</h3>
          <span><span style="color:#d946ef">‚óè</span> Online</span>
        </div>
        <div style="flex:1"></div>
        <button id="globalVoiceToggle" class="voice-btn" title="Bot Voice Output">
          <i class="fas fa-volume-up"></i>
        </button>
        <button id="logoutBtn" onclick="logout()" class="voice-btn" style="margin-left: 8px;" title="Logout">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>

      <div class="chat-area" id="chatArea">
        <!-- Messages will be injected here -->
      </div>

      <div class="typing-indicator" id="typingIndicator">
        <span></span><span></span><span></span>
      </div>
    </div>

    <!-- RIGHT: INPUT PANEL -->
    <div class="input-panel">
      <form id="onboardingForm">
        <div class="input-stage-container" id="formContainer">
          <!-- Dynamically Injected Fields -->
        </div>

        <div class="action-bar">
          <button type="button" id="nextBtn" class="btn-next" onclick="handleNextClick()">
            Continue <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="js/auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script>
    if (!requireAuth()) {
      // Redirect handled by requireAuth
    }

    // --- Data & State ---
    const steps = [
      {
        id: 'academic',
        question: "Let's start by getting to know your academic background. What is your current education level and field of study?",
        html: `
            <div class="custom-input-group">
              <label for="currentEducationLevel">Current Education Level</label>
              <div class="input-wrapper">
                  <select id="currentEducationLevel" name="currentEducationLevel" class="custom-input" required>
                    <option value="">Select level</option>
                    <option value="High School">High School / Secondary</option>
                    <option value="Diploma">Diploma / Certificate</option>
                    <option value="Bachelor's">Bachelor's Degree</option>
                    <option value="Master's">Master's Degree</option>
                    <option value="PhD">PhD / Doctorate</option>
                  </select>
              </div>
            </div>
            <div class="custom-input-group">
              <label for="major">Field of Study / Major</label>
              <div class="input-wrapper">
                  <select id="major" name="major" class="custom-input" required>
                    <option value="">Select field</option>
                    <optgroup label="Engineering & Technology">
                      <option value="Computer Science">Computer Science</option>
                      <option value="Software Engineering">Software Engineering</option>
                      <option value="Information Technology">Information Technology</option>
                      <option value="Data Science">Data Science</option>
                      <option value="Artificial Intelligence">Artificial Intelligence</option>
                      <option value="Cybersecurity">Cybersecurity</option>
                      <option value="Mechanical Engineering">Mechanical Engineering</option>
                      <option value="Electrical Engineering">Electrical Engineering</option>
                      <option value="Electronics & Communication">Electronics & Communication</option>
                      <option value="Civil Engineering">Civil Engineering</option>
                      <option value="Chemical Engineering">Chemical Engineering</option>
                      <option value="Aerospace Engineering">Aerospace Engineering</option>
                      <option value="Biomedical Engineering">Biomedical Engineering</option>
                      <option value="Robotocs">Robotics</option>
                      <option value="Automotive Engineering">Automotive Engineering</option>
                    </optgroup>
                    <optgroup label="Business & Management">
                      <option value="Business Administration">Business Administration</option>
                      <option value="Finance">Finance</option>
                      <option value="Marketing">Marketing</option>
                      <option value="Accounting">Accounting</option>
                      <option value="Economics">Economics</option>
                      <option value="Management">Management</option>
                      <option value="International Business">International Business</option>
                      <option value="Supply Chain Management">Supply Chain Management</option>
                      <option value="Human Resources">Human Resources</option>
                      <option value="Entrepreneurship">Entrepreneurship</option>
                    </optgroup>
                    <optgroup label="Health & Medicine">
                      <option value="Medicine (MBBS/MD)">Medicine (MBBS/MD)</option>
                      <option value="Nursing">Nursing</option>
                      <option value="Pharmacy">Pharmacy</option>
                      <option value="Public Health">Public Health</option>
                      <option value="Dentistry">Dentistry</option>
                      <option value="Physiotherapy">Physiotherapy</option>
                      <option value="Psychology">Psychology</option>
                      <option value="Biotechnology">Biotechnology</option>
                      <option value="Nutrition & Dietetics">Nutrition & Dietetics</option>
                    </optgroup>
                    <optgroup label="Sciences">
                      <option value="Physics">Physics</option>
                      <option value="Chemistry">Chemistry</option>
                      <option value="Biology">Biology</option>
                      <option value="Mathematics">Mathematics</option>
                      <option value="Statistics">Statistics</option>
                      <option value="Environmental Science">Environmental Science</option>
                      <option value="Geology">Geology</option>
                      <option value="Astronomy">Astronomy</option>
                    </optgroup>
                    <optgroup label="Arts, Humanities & Social Sciences">
                      <option value="Law">Law</option>
                      <option value="Political Science">Political Science</option>
                      <option value="International Relations">International Relations</option>
                      <option value="Sociology">Sociology</option>
                      <option value="History">History</option>
                      <option value="Philosophy">Philosophy</option>
                      <option value="English Literature">English Literature</option>
                      <option value="Journalism & Mass Comm">Journalism & Mass Comm</option>
                      <option value="Design (Graphic/Industrial/Fashion)">Design</option>
                      <option value="Architecture">Architecture</option>
                      <option value="Fine Arts">Fine Arts</option>
                      <option value="Education">Education</option>
                    </optgroup>
                    <option value="Other">Other</option>
                  </select>
              </div>
            </div>
            <div class="custom-input-group">
                <label for="graduationYear">Year of Graduation</label>
                <div class="input-wrapper">
                    <input type="number" id="graduationYear" name="graduationYear" class="custom-input" placeholder="e.g. 2024" />
                    <button type="button" class="mic-input-btn" onclick="startDictation('graduationYear')"><i class="fas fa-microphone"></i></button>
                </div>
            </div>
            <div class="custom-input-group">
                <label for="gpa">GPA / Percentage</label>
                <div class="input-wrapper">
                  <input type="text" id="gpa" name="gpa" class="custom-input" placeholder="e.g. 3.8 or 90%" />
                  <button type="button" class="mic-input-btn" onclick="startDictation('gpa')"><i class="fas fa-microphone"></i></button>
                </div>
            </div>
        `
      },
      {
        id: 'goals',
        question: "Great! Now, what are your future study goals? Tell me about the degree and specialization you're targeting.",
        html: `
            <div class="custom-input-group">
              <label for="intendedDegree">Intended Degree</label>
              <div class="input-wrapper">
                  <select id="intendedDegree" name="intendedDegree" class="custom-input" required>
                    <option value="">Select degree</option>
                    <option value="Bachelor's">Bachelor's</option>
                    <option value="Master's">Master's</option>
                    <option value="MBA">MBA</option>
                    <option value="PhD">PhD</option>
                  </select>
              </div>
            </div>
            <div class="custom-input-group">
              <label for="fieldOfStudy">Target Specialization</label>
              <div class="input-wrapper">
                  <select id="fieldOfStudy" name="fieldOfStudy" class="custom-input" required>
                    <option value="">Select specialization</option>
                    <optgroup label="Engineering & Technology">
                      <option value="Computer Science">Computer Science</option>
                      <option value="Software Engineering">Software Engineering</option>
                      <option value="Information Technology">Information Technology</option>
                      <option value="Data Science">Data Science</option>
                      <option value="Artificial Intelligence">Artificial Intelligence</option>
                      <option value="Cybersecurity">Cybersecurity</option>
                      <option value="Mechanical Engineering">Mechanical Engineering</option>
                      <option value="Electrical Engineering">Electrical Engineering</option>
                      <option value="Electronics & Communication">Electronics & Communication</option>
                      <option value="Civil Engineering">Civil Engineering</option>
                      <option value="Chemical Engineering">Chemical Engineering</option>
                      <option value="Aerospace Engineering">Aerospace Engineering</option>
                      <option value="Biomedical Engineering">Biomedical Engineering</option>
                      <option value="Robotics">Robotics</option>
                      <option value="Automotive Engineering">Automotive Engineering</option>
                    </optgroup>
                    <optgroup label="Business & Management">
                      <option value="Business Administration">Business Administration</option>
                      <option value="Finance">Finance</option>
                      <option value="Marketing">Marketing</option>
                      <option value="Accounting">Accounting</option>
                      <option value="Economics">Economics</option>
                      <option value="Management">Management</option>
                      <option value="International Business">International Business</option>
                      <option value="Supply Chain Management">Supply Chain Management</option>
                      <option value="Human Resources">Human Resources</option>
                      <option value="Entrepreneurship">Entrepreneurship</option>
                      <option value="Business Analytics">Business Analytics</option>
                    </optgroup>
                    <optgroup label="Health & Medicine">
                      <option value="Medicine (MBBS/MD)">Medicine (MBBS/MD)</option>
                      <option value="Nursing">Nursing</option>
                      <option value="Pharmacy">Pharmacy</option>
                      <option value="Public Health">Public Health</option>
                      <option value="Dentistry">Dentistry</option>
                      <option value="Physiotherapy">Physiotherapy</option>
                      <option value="Psychology">Psychology</option>
                      <option value="Biotechnology">Biotechnology</option>
                      <option value="Nutrition & Dietetics">Nutrition & Dietetics</option>
                    </optgroup>
                    <optgroup label="Sciences">
                      <option value="Physics">Physics</option>
                      <option value="Chemistry">Chemistry</option>
                      <option value="Biology">Biology</option>
                      <option value="Mathematics">Mathematics</option>
                      <option value="Statistics">Statistics</option>
                      <option value="Environmental Science">Environmental Science</option>
                      <option value="Geology">Geology</option>
                      <option value="Astronomy">Astronomy</option>
                    </optgroup>
                    <optgroup label="Arts, Humanities & Social Sciences">
                      <option value="Law">Law</option>
                      <option value="Political Science">Political Science</option>
                      <option value="International Relations">International Relations</option>
                      <option value="Sociology">Sociology</option>
                      <option value="History">History</option>
                      <option value="Philosophy">Philosophy</option>
                      <option value="English Literature">English Literature</option>
                      <option value="Journalism & Mass Comm">Journalism & Mass Comm</option>
                      <option value="Design">Design (Graphic/Industrial/Fashion)</option>
                      <option value="Architecture">Architecture</option>
                      <option value="Fine Arts">Fine Arts</option>
                      <option value="Education">Education</option>
                    </optgroup>
                    <option value="Other">Other</option>
                  </select>
              </div>
            </div>
            <div class="custom-input-group">
                <label for="preferredCountries">Preferred Countries</label>
                <select id="preferredCountries" name="preferredCountries" multiple required>
                   <!-- Populated via JS -->
                </select>
            </div>
            <div class="custom-input-group">
                <label for="targetIntakeYear">Target Intake Year</label>
                <div class="input-wrapper">
                  <input type="number" id="targetIntakeYear" name="targetIntakeYear" class="custom-input" placeholder="2025" />
                  <button type="button" class="mic-input-btn" onclick="startDictation('targetIntakeYear')"><i class="fas fa-microphone"></i></button>
                </div>
            </div>
        `
      },
      {
        id: 'budget',
        question: "Understanding your budget is key to finding the right fit. What is your estimated annual budget and funding plan?",
        html: `
            <div class="custom-input-group">
              <label for="budgetRange">Annual Budget (USD)</label>
              <div class="input-wrapper">
                  <select id="budgetRange" name="budgetRange" class="custom-input" required>
                    <option value="">Select range</option>
                    <option value="< $10,000">&lt; $10,000</option>
                    <option value="$10,000 - $30,000">$10,000 - $30,000</option>
                    <option value="$30,000 - $50,000">$30,000 - $50,000</option>
                    <option value="$50,000 - $100,000">$50,000 - $100,000</option>
                    <option value="> $100,000">&gt; $100,000</option>
                  </select>
              </div>
            </div>
             <div class="custom-input-group">
              <label for="fundingPlan">Funding Source</label>
              <div class="input-wrapper">
                  <select id="fundingPlan" name="fundingPlan" class="custom-input" required>
                    <option value="">Select plan</option>
                    <option value="Self-funded">Self-funded</option>
                    <option value="Scholarship-dependent">Scholarship-dependent</option>
                    <option value="Loan-dependent">Loan-dependent</option>
                    <option value="Mixed">Mixed</option>
                  </select>
              </div>
            </div>
        `
      },
      {
        id: 'exams',
        question: "Almost done! Do you have any exam scores yet? This helps us check eligibility.",
        html: `
            <div class="custom-input-group">
              <label for="ieltsStatus">IELTS Status</label>
              <div class="input-wrapper">
                  <select id="ieltsStatus" name="ieltsStatus" class="custom-input" onchange="toggleScore('ieltsStatus', 'ieltsScoreWrapper')">
                    <option value="Not started">Not started</option>
                    <option value="In progress">In progress</option>
                    <option value="Completed">Completed</option>
                  </select>
              </div>
            </div>
            <div id="ieltsScoreWrapper" class="custom-input-group" style="display:none; margin-left: 20px; border-left: 2px solid var(--accent); padding-left: 15px;">
                <label for="ieltsScore">IELTS Score</label>
                 <div class="input-wrapper">
                    <input type="number" id="ieltsScore" name="ieltsScore" class="custom-input" step="0.5" placeholder="e.g. 7.5" />
                    <button type="button" class="mic-input-btn" onclick="startDictation('ieltsScore')"><i class="fas fa-microphone"></i></button>
                 </div>
            </div>

            <div class="custom-input-group">
              <label for="toeflStatus">TOEFL Status</label>
              <div class="input-wrapper">
                  <select id="toeflStatus" name="toeflStatus" class="custom-input" onchange="toggleScore('toeflStatus', 'toeflScoreWrapper')">
                    <option value="Not started">Not started</option>
                    <option value="In progress">In progress</option>
                    <option value="Completed">Completed</option>
                  </select>
              </div>
            </div>
             <div id="toeflScoreWrapper" class="custom-input-group" style="display:none; margin-left: 20px; border-left: 2px solid var(--accent); padding-left: 15px;">
                <label for="toeflScore">TOEFL Score</label>
                 <div class="input-wrapper">
                    <input type="number" id="toeflScore" name="toeflScore" class="custom-input" placeholder="e.g. 100" />
                    <button type="button" class="mic-input-btn" onclick="startDictation('toeflScore')"><i class="fas fa-microphone"></i></button>
                 </div>
            </div>
            
             <div class="custom-input-group">
              <label for="greStatus">GRE Status</label>
              <div class="input-wrapper">
                  <select id="greStatus" name="greStatus" class="custom-input" onchange="toggleScore('greStatus', 'greScoreWrapper')">
                     <option value="Not started">Not started</option>
                    <option value="In progress">In progress</option>
                    <option value="Completed">Completed</option>
                  </select>
              </div>
            </div>
             <div id="greScoreWrapper" class="custom-input-group" style="display:none; margin-left: 20px; border-left: 2px solid var(--accent); padding-left: 15px;">
                <label for="greScore">GRE Score</label>
                 <div class="input-wrapper">
                    <input type="number" id="greScore" name="greScore" class="custom-input" placeholder="e.g. 320" />
                    <button type="button" class="mic-input-btn" onclick="startDictation('greScore')"><i class="fas fa-microphone"></i></button>
                 </div>
            </div>
        `
      }
    ];

    let currentStepIndex = 0;
    let countriesChoicesInstance = null;
    let voiceEnabled = true;
    const profileData = {}; // Store data across steps

    // ... (Voice Logic remains same) ...

    // --- UI Logic ---
    // ... (typeMessage remains same) ...
    // ... (renderStep remains same) ...

    // ... (initCountries remains same) ...
    // ... (toggleScore remains same) ...

    async function handleNextClick() {
      const container = document.getElementById('formContainer');
      const inputs = container.querySelectorAll('input, select');
      let valid = true;

      // 1. Validate
      inputs.forEach(input => {
        if (input.hasAttribute('required') && !input.value) {
          if (input.id === 'preferredCountries') {
            if (countriesChoicesInstance && countriesChoicesInstance.getValue(true).length === 0) {
              valid = false;
            }
          } else {
            valid = false;
            input.style.borderColor = '#ef4444';
            setTimeout(() => input.style.borderColor = 'rgba(148, 163, 184, 0.2)', 2000);
          }
        }
      });

      if (!valid && currentStepIndex < steps.length) {
        typeMessage("Please fill in the required fields before we continue.");
        return;
      }

      // 2. Save Data to State
      inputs.forEach(input => {
        if (input.id === 'preferredCountries' && countriesChoicesInstance) {
          profileData['preferredCountries'] = countriesChoicesInstance.getValue(true);
        } else {
          // Only save if it has a name and value
          if (input.name) {
            profileData[input.name] = input.value;
          }
        }
      });

      // Echo User Answer
      const summary = getUserSummary(currentStepIndex);
      if (summary) {
        appendUserMessage(summary);
      }

      // Move to next or submit
      if (currentStepIndex < steps.length - 1) {
        currentStepIndex++;
        renderStep(currentStepIndex);
      } else {
        // Final submit
        await submitProfile();
      }
    }

    function getUserSummary(index) {
      // Helper to format a nice summary string based on the step inputs
      const container = document.getElementById('formContainer');
      const inputs = Array.from(container.querySelectorAll('input, select'));

      let parts = [];
      inputs.forEach(input => {
        if (!input.value) return;
        // Skip hidden score fields if they are empty or hidden
        if (input.offsetParent === null) return;

        if (input.tagName === 'SELECT') {
          // For multi-select specific handling
          if (input.id === 'preferredCountries' && countriesChoicesInstance) {
            const selected = countriesChoicesInstance.getValue(true);
            if (selected.length) parts.push(selected.join(', '));
          } else {
            parts.push(input.value);
          }
        } else {
          parts.push(input.value);
        }
      });
      return parts.join(" | ");
    }

    async function submitProfile() {
      const btn = document.getElementById('nextBtn');
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
      btn.disabled = true;

      try {
        // Use apiRequest from auth.js to handle Base URL and Token automatically
        await apiRequest('/profiles', {
          method: 'POST',
          body: JSON.stringify(profileData)
        });

        typeMessage("Profile completed successfully! Redirecting you...", () => {
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 1500);
        });

      } catch (e) {
        console.error(e);
        typeMessage(`Error: ${e.message}. Please try again.`);
        btn.innerHTML = 'Try Again';
        btn.disabled = false;
      }
    }
    const synth = window.speechSynthesis;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;

    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
    }

    function toggleVoice() {
      voiceEnabled = !voiceEnabled;
      const btn = document.getElementById('globalVoiceToggle');
      if (voiceEnabled) {
        btn.innerHTML = '<i class="fas fa-volume-up"></i>';
        btn.classList.add('active');
      } else {
        btn.innerHTML = '<i class="fas fa-volume-mute"></i>';
        btn.classList.remove('active');
        synth.cancel();
      }
    }

    // Initialize toggle button
    document.getElementById('globalVoiceToggle').addEventListener('click', toggleVoice);

    function speak(text) {
      if (!voiceEnabled) return;
      if (synth.speaking) synth.cancel();

      const utterance = new SpeechSynthesisUtterance(text);
      // Select a decent voice if available
      const voices = synth.getVoices();
      const preferred = voices.find(v => v.name.includes('Google US English') || v.name.includes('Samantha'));
      if (preferred) utterance.voice = preferred;

      utterance.rate = 1;
      utterance.pitch = 1;
      synth.speak(utterance);
    }

    function startDictation(inputId) {
      if (!recognition) {
        alert("Speech Recognition is not supported in this browser. Try Chrome.");
        return;
      }

      const btn = document.querySelector(`button[onclick="startDictation('${inputId}')"]`);
      btn.classList.add('listening');

      recognition.start();

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        const input = document.getElementById(inputId);
        if (input) {
          // Simple heuristics for numbers if input is number type
          if (input.type === 'number') {
            const num = transcript.match(/\d+(\.\d+)?/);
            if (num) input.value = num[0];
          } else {
            input.value = transcript;
          }
        }
        btn.classList.remove('listening');
      };

      recognition.onerror = (event) => {
        console.error("Speech error", event.error);
        btn.classList.remove('listening');
      };

      recognition.onend = () => {
        btn.classList.remove('listening');
      }
    }

    // --- UI Logic ---

    function typeMessage(text, callback) {
      const chatArea = document.getElementById('chatArea');
      const indicators = document.getElementById('typingIndicator');

      indicators.style.display = 'block';
      chatArea.scrollTop = chatArea.scrollHeight;

      // Artificial delay for "thinking"
      setTimeout(() => {
        indicators.style.display = 'none';

        const msgDiv = document.createElement('div');
        msgDiv.className = 'message bot';
        msgDiv.innerHTML = `
                <div class="chat-avatar bot">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="bubble">${text}</div>
            `;
        chatArea.appendChild(msgDiv);
        requestAnimationFrame(() => {
          chatArea.scrollTop = chatArea.scrollHeight;
        });

        if (voiceEnabled) speak(text);
        if (callback) callback();
      }, 1200);
    }

    function renderStep(index) {
      const container = document.getElementById('formContainer');
      const step = steps[index];

      // Fade out
      container.style.opacity = '0';

      setTimeout(() => {
        // Inject new form HTML
        container.innerHTML = `<div class="form-step active" id="step-${index}">${step.html}</div>`;

        // Re-initialize plugins (Choices.js) if needed
        if (index === 1) { // Goals step
          initCountries();
        }
        // Restore opacity
        container.style.opacity = '1';

        // Ask the question
        typeMessage(step.question);

        // Update button text
        const btn = document.getElementById('nextBtn');
        btn.innerHTML = (index === steps.length - 1) ?
          'Finish Profile <i class="fas fa-check"></i>' :
          'Continue <i class="fas fa-arrow-right"></i>';

      }, 300);
    }

    function initCountries() {
      const countries = [
        'United States', 'United Kingdom', 'Canada', 'Australia', 'Germany',
        'France', 'Netherlands', 'Sweden', 'Switzerland', 'Singapore',
        'Japan', 'South Korea', 'New Zealand', 'Ireland', 'Italy'
      ];
      const select = document.getElementById('preferredCountries');
      if (!select) return;

      select.innerHTML = '';
      countries.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
      });

      if (countriesChoicesInstance) {
        countriesChoicesInstance.destroy();
      }

      countriesChoicesInstance = new Choices(select, {
        removeItemButton: true,
        placeholderValue: 'Select countries...',
        searchPlaceholderValue: 'Type to search...'
      });
    }

    // Helper to toggle Exam score fields
    window.toggleScore = function (statusId, wrapperId) {
      const status = document.getElementById(statusId).value;
      const wrapper = document.getElementById(wrapperId);
      if (status === 'In progress' || status === 'Completed') {
        wrapper.style.display = 'block';
      } else {
        wrapper.style.display = 'none';
      }
    }



    function appendUserMessage(text) {
      const chatArea = document.getElementById('chatArea');
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message user';
      msgDiv.innerHTML = `
            <div class="chat-avatar user">
                <i class="fas fa-user"></i>
            </div>
            <div class="bubble">${text}</div>
        `;
      chatArea.appendChild(msgDiv);
      requestAnimationFrame(() => {
        chatArea.scrollTop = chatArea.scrollHeight;
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Load voices
      speechSynthesis.getVoices();

      // Initial bot greeting
      setTimeout(() => {
        typeMessage("Hi there! I'm your AI Education Counsellor. I'll help you find the perfect university from my database. Ready to build your profile?", () => {
          // Show first step after greeting
          renderStep(0);
        });
      }, 500);
    });

  </script>
</body>

</html>