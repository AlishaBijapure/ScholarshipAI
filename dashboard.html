<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - AI Counsellor</title>
  <link rel="stylesheet" href="css/counsellor.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/dashboard.css">
</head>

<body>
  <nav class="navbar">
    <div class="logo">AI Counsellor</div>
    <div class="burger-menu" id="burger-menu">
      <i class="fas fa-bars"></i>
    </div>
    <ul class="nav-links">
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="counsellor.html">AI Counsellor</a></li>
      <li><a href="universities.html">Universities</a></li>
      <li><a href="profile.html">Profile</a></li>
      <li><a href="#" onclick="logout(); return false;" class="btn-logout">Logout</a></li>
    </ul>
  </nav>

  <div class="dashboard-container">
    <!-- Prominent AI Counsellor CTA -->
    <a href="counsellor.html" class="counsellor-banner">
      <i class="fas fa-robot"></i> Go to AI Counsellor to Move to the Next Stage!
    </a>

    <!-- Completion Banner (Hidden by default) -->
    <div id="completionBanner" class="completion-banner hidden">
      <div class="completion-banner-inner">
        <i class="fas fa-trophy completion-icon"></i>
        <h2>Congratulations! All Tasks Completed!</h2>
        <p>You have successfully prepared everything. Good luck with your applications!</p>
      </div>
    </div>

    <div class="welcome-section">
      <h1 id="welcomeName">Welcome!</h1>
      <p id="welcomeStage">Loading your journey...</p>
      <div class="stage-indicator" id="stageIndicator"></div>
    </div>

    <div class="dashboard-grid">
      <!-- Profile Strength -->
      <div class="dashboard-card">
        <h3><i class="fas fa-chart-line"></i> Profile Strength</h3>
        <div class="profile-strength" id="profileStrength">
          <div class="strength-item">
            <span class="strength-label">Academics</span>
            <span class="strength-value" id="academicsStrength">-</span>
          </div>
          <div class="strength-item">
            <span class="strength-label">Exams</span>
            <span class="strength-value" id="examsStrength">-</span>
          </div>
          <div class="strength-item">
            <span class="strength-label">SOP</span>
            <span class="strength-value" id="sopStrength">-</span>
          </div>
          <div class="strength-item">
            <span class="strength-label">Overall</span>
            <span class="strength-value" id="overallStrength">-</span>
          </div>
        </div>
      </div>

      <!-- Stats -->
      <div class="dashboard-card">
        <h3><i class="fas fa-chart-bar"></i> Your Progress</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-number" id="shortlistedCount">0</div>
            <div class="stat-label">Shortlisted</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="lockedCount">0</div>
            <div class="stat-label">Locked</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="todosCount">0</div>
            <div class="stat-label">Total Tasks</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="completedTodosCount">0</div>
            <div class="stat-label">Completed</div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="dashboard-card">
        <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
        <div class="quick-actions">
          <a href="counsellor.html" class="action-btn">Talk to AI Counsellor</a>
          <a href="universities.html" class="action-btn">Discover Universities</a>
          <!-- Documents Tab (Gated) -->
          <a href="#" id="docsBtn" class="action-btn"
            style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
            Documents <i class="fas fa-lock text-xs opacity-50 ml-1"></i>
          </a>
        </div>
      </div>
    </div>

    <!-- Recent Todos -->
    <div class="dashboard-card">
      <h3><i class="fas fa-tasks"></i> Recent Tasks</h3>
      <div class="todo-list" id="recentTodos">
        <p style="color: #7f8c8d; text-align: center;">No tasks yet. Start by talking to your AI Counsellor!</p>
      </div>
    </div>
  </div>

  <script src="js/auth.js"></script>
  <script src="js/navbar.js"></script>
  <script>
    if (!requireAuth()) {
      // Redirect handled
    }

    async function loadDashboard() {
      // Create Modal for Guidance Gate (Frontend Only)
      function showGuidanceGateModal() {
        if (document.getElementById('gateModal')) return;
        const modal = document.createElement('div');
        modal.id = 'gateModal';
        modal.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-80 backdrop-blur-sm';
        modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px);';

        modal.innerHTML = `
            <div style="background: var(--card-bg); padding: 30px; border-radius: 16px; border: 1px solid var(--primary-color); max-width: 400px; text-align: center; box-shadow: 0 0 30px rgba(217, 70, 239, 0.3);">
                <i class="fas fa-lock" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 20px;"></i>
                <h3 style="margin: 0 0 10px; color: #fff;">Complete University Selection</h3>
                <p style="color: var(--text-light); margin-bottom: 24px;">To access personalized Application Guidance, you need to finalize your university shortlist first.</p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="closeGateBtn" style="padding: 10px 20px; border-radius: 8px; border: 1px solid var(--text-light); background: transparent; color: var(--text-light); cursor: pointer;">Close</button>
                    <a href="counsellor.html" style="display:inline-block; padding: 10px 20px; border-radius: 8px; background: var(--primary-color); color: white; text-decoration: none; font-weight: 600;">Go to AI Counsellor</a>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        document.getElementById('closeGateBtn').onclick = () => modal.remove();
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
      }
      try {
        const data = await apiRequest('/dashboard');

        // Welcome section
        document.getElementById('welcomeName').textContent = `Welcome, ${data.user.fullName}!`;
        document.getElementById('welcomeStage').textContent = `Current Stage: ${data.user.stageName}`;

        // Stage indicator (driven by counsellor progress model)
        const stages = data.journeyStages || [];

        const stageIndicator = document.getElementById('stageIndicator');
        stageIndicator.innerHTML = '';
        stages.forEach((stage) => {
          const className = stage.status || 'pending';
          const badge = document.createElement('div');
          badge.className = `stage-badge ${className}`;
          badge.innerHTML = `
            <span>${stage.name}</span>
          `;
          stageIndicator.appendChild(badge);
        });

        // Show Application Guidance ALWAYS (but gated)
        const quickActions = document.querySelector('.quick-actions');
        if (quickActions && !quickActions.querySelector('.guidance-btn')) {
          const guidanceBtn = document.createElement('a');
          guidanceBtn.href = '#';
          guidanceBtn.className = 'action-btn guidance-btn';
          guidanceBtn.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
          guidanceBtn.innerHTML = 'Application Guidance <i class="fas fa-lock text-xs opacity-50 ml-1"></i>';

          // Check if locked items exist to update icon/style immediately (optional visual hint)
          if (data.stats && data.stats.lockedCount > 0) {
            guidanceBtn.innerHTML = 'Application Guidance'; // Remove lock icon if unlocked
          }

          guidanceBtn.onclick = (e) => {
            e.preventDefault();
            if (data.stats && data.stats.lockedCount > 0) {
              window.location.href = 'guidance.html';
            } else {
              showGuidanceGateModal();
            }
          };
          quickActions.appendChild(guidanceBtn);
        }

        // --- Logic for Documents Button (Frontend Gating) ---
        const docsBtn = document.getElementById('docsBtn');
        if (docsBtn) {
          // Check if user is at the final stage (Task 4: SoPs/LoRs)
          // We'll check if 'preparing_lors_sops' is active or completed
          const sopTask = (data.journeyStages || []).find(s => s.key === 'preparing_lors_sops');

          // Allow access if Task 3 (Documents) is completed, meaning they are now on SOPs
          const docsTask = (data.journeyStages || []).find(s => s.key === 'preparing_documents');

          const canAccessDocs = (docsTask && docsTask.status === 'completed') || (sopTask && (sopTask.status === 'active' || sopTask.status === 'completed'));

          if (canAccessDocs) {
            docsBtn.innerHTML = 'Documents Workspace'; // remove lock
            docsBtn.onclick = () => { window.location.href = 'documents.html'; };
          } else {
            docsBtn.onclick = (e) => {
              e.preventDefault();
              // Show Modal explaining why it's locked
              const modal = document.createElement('div');
              modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px);';
              modal.innerHTML = `
                        <div style="background: var(--card-bg); padding: 30px; border-radius: 16px; border: 1px solid #f59e0b; max-width: 400px; text-align: center; box-shadow: 0 0 30px rgba(245, 158, 11, 0.3);">
                            <i class="fas fa-pencil-alt" style="font-size: 3rem; color: #f59e0b; margin-bottom: 20px;"></i>
                            <h3 style="margin: 0 0 10px; color: #fff;">Documents Locked</h3>
                            <p style="color: var(--text-light); margin-bottom: 24px;">This workspace unlocks when you reach the <strong>SOP & LOR Writing</strong> stage. Please complete your previous tasks first!</p>
                            <button id="closeDocGate" style="padding: 10px 20px; border-radius: 8px; background: var(--secondary-color); color: white; border:none; cursor: pointer;">Got it</button>
                        </div>
                    `;
              document.body.appendChild(modal);
              document.getElementById('closeDocGate').onclick = () => modal.remove();
              modal.onclick = (ev) => { if (ev.target === modal) modal.remove(); };
            };
          }
        }

        // Profile strength
        let strength = data.profileStrength;

        // --- Frontend Override: Dynamic Strength based on Task Progress ---
        // Task 2: Exams (key: taking_exams)
        const examsTask = (data.journeyStages || []).find(s => s.key === 'taking_exams');
        if (examsTask && examsTask.status === 'completed') {
          strength.exams = 'Excellent';
        }

        // Task 3 & 4: Documents and SOPs
        const docsTask = (data.journeyStages || []).find(s => s.key === 'preparing_documents');
        const sopTask = (data.journeyStages || []).find(s => s.key === 'preparing_lors_sops');

        if (docsTask && docsTask.status === 'completed') {
          // If docs are done, SOPs are at least ongoing (or done)
          if (sopTask && sopTask.status === 'completed') {
            strength.sop = 'Excellent';
          } else {
            strength.sop = 'Good (Ongoing)';
          }
        }
        // ----------------------------------------------------------------

        document.getElementById('academicsStrength').textContent = strength.academics;
        document.getElementById('academicsStrength').className = `strength-value ${strength.academics.toLowerCase()}`;

        const examsClass = strength.exams === 'Excellent' ? 'strong' : strength.exams.toLowerCase();
        document.getElementById('examsStrength').textContent = strength.exams;
        document.getElementById('examsStrength').className = `strength-value ${examsClass}`;

        let sopClass = strength.sop.toLowerCase();
        if (strength.sop.includes('Excellent')) sopClass = 'strong';
        else if (strength.sop.includes('Good')) sopClass = 'average';

        document.getElementById('sopStrength').textContent = strength.sop;
        document.getElementById('sopStrength').className = `strength-value ${sopClass}`;

        // Refine overall if sub-parts are strong (optional visual perk)
        if (strength.exams === 'Excellent' && strength.sop === 'Excellent') {
          strength.overall = 'Strong';
        }

        document.getElementById('overallStrength').textContent = strength.overall;
        document.getElementById('overallStrength').className = `strength-value ${strength.overall.toLowerCase()}`;

        // Stats
        document.getElementById('shortlistedCount').textContent = data.stats.shortlistedCount;
        document.getElementById('lockedCount').textContent = data.stats.lockedCount;
        document.getElementById('todosCount').textContent = data.stats.todosCount;
        document.getElementById('completedTodosCount').textContent = data.stats.completedTodosCount;

        // Check for total completion
        if (data.stats.todosCount > 0 && data.stats.completedTodosCount === data.stats.todosCount) {
          document.getElementById('completionBanner').classList.remove('hidden');
          // Hide the "Go to AI Counsellor" CTA since they are done
          const counsellorBanner = document.querySelector('.counsellor-banner');
          if (counsellorBanner) counsellorBanner.style.display = 'none';
        }

        // Render all journey stages in order (Timeline View)
        const todosContainer = document.getElementById('recentTodos');
        const tasks = data.journeyStages || []; // Use journeyStages instead of recentTasks to keep order

        // Filter out "Building Profile" if desired (Task 0 in counsellor is task 0 here usually)
        // But user wants "Task 0 Country Selection" which is key='finalizing_country'
        // Let's show all except maybe "Building Profile" if it's too basic, but let's keep all for completeness.

        if (tasks.length > 0) {
          todosContainer.innerHTML = '';
          tasks.forEach(task => {
            const todoItem = document.createElement('div');
            const status = task.status || 'pending';
            const isCompleted = status === 'completed';
            const isActive = status === 'active';

            // Helper to get content based on task name
            let detailsHtml = '';

            if (isCompleted) {
              if (task.name.includes('Country')) {
                // Task 0: Show Country Name
                // Try to find country from locked/shortlisted unis or profile
                let country = 'Selected';
                if (data.locked && data.locked.length > 0) country = data.locked[0].country;
                else if (data.shortlisted && data.shortlisted.length > 0) country = data.shortlisted[0].country;
                else if (data.profile && data.profile.preferredCountries && data.profile.preferredCountries.length > 0) country = data.profile.preferredCountries[0];

                detailsHtml = `<div class="task-result-detail"><strong>${country}</strong> <i class="fas fa-check-circle text-green-500"></i></div>`;
              } else if (task.name.includes('Universities')) {
                // Task 1: Show list of 5 universities
                if (data.locked && data.locked.length > 0) {
                  const uniNames = data.locked.slice(0, 5).map(u => u.name).join(', ');
                  detailsHtml = `<div class="task-result-detail small-text">${uniNames}</div>`;
                } else {
                  detailsHtml = `<div class="task-result-detail">List Finalized</div>`;
                }
              } else if (task.name.includes('Exams') || task.name.includes('Documents') || task.name.includes('SOPs')) {
                // Task 2, 3, 4: Big Green Tick
                detailsHtml = `<div class="task-result-detail big-tick"><i class="fas fa-check-circle"></i></div>`;
              }
            }

            todoItem.className = `todo-item ${isCompleted ? 'completed' : ''}`;
            todoItem.innerHTML = `
              <div>
                <div class="todo-title ${isCompleted ? 'completed' : ''}">${task.name}</div>
                <div class="todo-category">Counsellor Journey</div>
                ${detailsHtml}
              </div>
              <span class="todo-status-pill ${isCompleted ? 'completed' : isActive ? 'active' : ''}">
                ${isCompleted ? 'Completed' : isActive ? 'In Progress' : 'Upcoming'}
              </span>
            `;
            todosContainer.appendChild(todoItem);
          });
        }
      } catch (error) {
        console.error('Error loading dashboard:', error);
        if (error.message && (error.message.includes('onboarding') || error.message.includes('Complete onboarding'))) {
          window.location.href = 'onboarding.html';
          return;
        }
        document.getElementById('welcomeName').textContent = 'Error loading dashboard';
        document.getElementById('welcomeStage').textContent = error.message || 'Please try again.';
      }
    }

    loadDashboard();
  </script>
</body>

</html>